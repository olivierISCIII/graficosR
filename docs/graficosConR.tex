\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={Gráficos con R},
            pdfauthor={Olivier Nuñez},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{natbib}
\bibliographystyle{plainnat}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\providecommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{Gráficos con R}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{Olivier Nuñez}
    \preauthor{\centering\large\emph}
  \postauthor{\par}
      \predate{\centering\large\emph}
  \postdate{\par}
    \date{2019-09-23}

\usepackage[spanish]{babel}
\selectlanguage{spanish}

\usepackage{xcolor}
\usepackage[framemethod=default]{mdframed}


\newcounter{ejcnt}[section]
\numberwithin{ejcnt}{section}

%\newenvironment{nota}
%{ \rule{1ex}{1ex}\hspace{\stretch{1}} }
%{ \hspace{\stretch{1}}\rule{1ex}{1ex} }


\global\mdfdefinestyle{exampledefault}{%
linecolor=lightgray,linewidth=1pt,%
leftmargin=1cm,rightmargin=1cm,
}

%\newenvironment{nota}[1]{%
\newenvironment{nota}{%
\mdfsetup{%
frametitle={\colorbox{white}{\,Nota\,}},
%frametitle={\colorbox{white}{\,#1\,}},
frametitleaboveskip=-\ht\strutbox,
frametitlealignment=\raggedright
}%
\begin{mdframed}[style=exampledefault]
}{\end{mdframed}}




\newenvironment{ej}[1][]{%
	\refstepcounter{ejcnt}%
	\par\medskip%
	\noindent% 
	\textbf{Ejercicio \theejcnt \;\;}% 
	\rmfamily%
}{\medskip}


%\newenvironment{ej}[1][]{\refstepcounter{ej}\par\medskip
%   \noindent \textbf{Ejercicio #1} \rmfamily}{\medskip}

%\newenvironment{ej}% environment name
%{% begin code
%  \par\vspace{\baselineskip}\noindent
%  \leftmargin=0.3in\rightmargin=0.3in
%  \textbf{Ejercicio:}
%  %\par\vspace{\baselineskip}\noindent\ignorespaces
%}%
%{% end code
%  \ignorespacesafterend
%}

%\makeatletter
%\renewcommand{\subsubsection}{\ttl@straightclass{subsubsection}}
%\makeatother
%\titleformat{\subsubsection}[hang]
%  {\fontsize{36}{42}\selectfont}
%  {\thesubsubsection}
%  {1em}
%  {}
%  []

\begin{document}
\maketitle

{
\setcounter{tocdepth}{2}
\tableofcontents
}
\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{knitr}\OperatorTok{::}\NormalTok{opts_chunk}\OperatorTok{$}\KeywordTok{set}\NormalTok{(}\DataTypeTok{warning =} \OtherTok{FALSE}\NormalTok{,}\DataTypeTok{message =} \OtherTok{FALSE}\NormalTok{, }\DataTypeTok{cache.lazy =} \OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{preambulo}{%
\section*{Preámbulo}\label{preambulo}}
\addcontentsline{toc}{section}{Preámbulo}

\begin{quote}
``Una imagen vale más que mil palabras'' (``Un bon croquis vaut mieux qu'un long discours'')

--- Napoleon
\end{quote}

\begin{itemize}
\item
  La representación gráfica de los datos es una potente herramienta de síntesis de la información estadística.
\item
  Cualquiera que sea la etapa de su trabajo (exploración, modelización, confirmación o comunicación de resultados), el usuario de métodos estadísticos encuentra en los gráficos un aliado para ahorrar tiempo.
\item
  El objetivo de esta sesión es manejar el paquete \texttt{ggplot2} de R y sus extensiones que permiten un diseño eficiente de gráficos para explorar la distribución de un conjunto de datos. Se abordarán los distintos pasos, que van desde la preparación de los datos hasta su exportación.
\item
  La estructura de esta sesión tiene tres partes:

  \begin{itemize}
  \tightlist
  \item
    La primera parte está dedicada a la definición y elaboración de las representaciones gráficas más comunes (diagrama de barras, de caja, de dispersión, histograma) para extraer la información contenida en un conjunto de datos.
  \item
    La segunda parte describe la ``gramática'' general de confección de gráficos utilizada en \texttt{ggplot2}. Esta gramática permite tratar de manera sistemática y flexible, aspectos básicos como la elección de los ejes, los colores y la leyenda. Pero también, temas avanzados como el problema de solapamiento de puntos, la superposición de varios elementos gráficos (capas) o el desglose de una representación en varios sub-gráficos (facetas).
  \item
    En la ultima parte, se presentarán las herramientas para insertar esta información gráfica en informes estáticos, dinámicos o automatizados, mediante los paquetes \texttt{Rmarkdown} y \texttt{Shiny}.
  \end{itemize}
\end{itemize}

\hypertarget{graficos-basicos-en-el-analisis-de-datos}{%
\section{Gráficos básicos en el análisis de datos}\label{graficos-basicos-en-el-analisis-de-datos}}

Esta sección es una breve introducción a los gráficos más comunes para analizar conjuntos de datos. Para ello, utilizaremos el paquete \texttt{ggplot2} (``gg'' para ``Grammar of Graphics'').

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#install.packages("ggplot2")}
\KeywordTok{library}\NormalTok{(ggplot2) }\CommentTok{#carga la librería ggplot2}
\end{Highlighting}
\end{Shaded}

Empezaremos con la función básica \texttt{qplot}(``quick plot'') de este paquete. Una descripción abreviada de esta función es

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{qplot}\NormalTok{(x, }\DataTypeTok{y=}\OtherTok{NULL}\NormalTok{, data, }\DataTypeTok{geom=}\StringTok{"auto"}\NormalTok{, }\DataTypeTok{xlim =} \KeywordTok{c}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\OtherTok{NA}\NormalTok{), }\DataTypeTok{ylim =}\KeywordTok{c}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\OtherTok{NA}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{nota}
\begin{itemize}
\tightlist
\item
  \texttt{x} : valores en el eje de abscisas.
\item
  \texttt{y} : valores en el de ordenadas (opcional).
\item
  \texttt{data} : data.frame de donde salen los datos (opcional).
\item
  \texttt{geom} : elementos gráficos o geometrías
  (``point'',line``,''bar``,\ldots). Por defecto, ``point'' si
  \texttt{y} viene especificado, e ``histogram'' si sólo se especifica
  \texttt{x}.
\item
  \texttt{xlim}, \texttt{ylim}: limites en los ejes de \texttt{x} e
  \texttt{y}.
\end{itemize}

Otros argumentos relacionados con los ejes y el titulo del gráfico son:
\texttt{main}: titulo del gráfico; \texttt{xlab}, \texttt{ylab}:
etiquetas los los ejes; \texttt{log}: ejes en escala log. Los valores
permitidos son ``x'', ``y'' o bien ``xy''.
\end{nota}

\hypertarget{distribucion-de-una-variable}{%
\subsection{Distribución de una variable}\label{distribucion-de-una-variable}}

Para intentar ver algo en un conjunto de datos, lo primero que se puede hacer es averiguar como se distribuyen sus valores. En R, hay funciones básicas (summary, stem, table, \ldots) que permiten tener una idea de esta distribución.

El tipo de representación gráfica de la distribución cambia según la naturaleza de la variable en estudio. Una variable cuantitativa toma valores numéricos. Para una variable cuantitativa, se suele recurrir a un \textbf{histograma} o bien a un \textbf{diagrama de caja} para describir su distribución. Mientras que para variables cualitativas (o categóricas), se utilizará un \emph{diagrama de barras}.

\hypertarget{histograma}{%
\subsubsection{Histograma}\label{histograma}}

Para ilustrar la descripción gráfica de la distribución de una variable numérica, se utiliza la base de datos \texttt{msleep} que contiene información sobre el tiempo de sueño (en horas) de mamíferos:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{msleep }\CommentTok{# ?msleep para más detalles}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 83 x 11
##    name  genus vore  order conservation sleep_total sleep_rem sleep_cycle
##    <chr> <chr> <chr> <chr> <chr>              <dbl>     <dbl>       <dbl>
##  1 Chee~ Acin~ carni Carn~ lc                  12.1      NA        NA    
##  2 Owl ~ Aotus omni  Prim~ <NA>                17         1.8      NA    
##  3 Moun~ Aplo~ herbi Rode~ nt                  14.4       2.4      NA    
##  4 Grea~ Blar~ omni  Sori~ lc                  14.9       2.3       0.133
##  5 Cow   Bos   herbi Arti~ domesticated         4         0.7       0.667
##  6 Thre~ Brad~ herbi Pilo~ <NA>                14.4       2.2       0.767
##  7 Nort~ Call~ carni Carn~ vu                   8.7       1.4       0.383
##  8 Vesp~ Calo~ <NA>  Rode~ <NA>                 7        NA        NA    
##  9 Dog   Canis carni Carn~ domesticated        10.1       2.9       0.333
## 10 Roe ~ Capr~ herbi Arti~ lc                   3        NA        NA    
## # ... with 73 more rows, and 3 more variables: awake <dbl>, brainwt <dbl>,
## #   bodywt <dbl>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#summary(msleep$sleep_total) #tiempo total de sueño (en horas)}
\KeywordTok{stem}\NormalTok{(msleep}\OperatorTok{$}\NormalTok{sleep_total)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##   The decimal point is at the |
## 
##    0 | 9
##    2 | 79013589
##    4 | 0423346
##    6 | 23307
##    8 | 03446779114456788
##   10 | 01113346900135
##   12 | 15555880578
##   14 | 234456996889
##   16 | 604
##   18 | 01479
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{qplot}\NormalTok{(sleep_total,}\DataTypeTok{data=}\NormalTok{msleep) }\CommentTok{#histograma }
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-6-1.pdf}

La altura de cada barra en el histograma es proporcional a la frecuencia de datos que caen en el intervalo correspondiente. Por defecto, en la función \texttt{qplot}el número de barras es igual a \texttt{bins=30}. Este valor es muy arbitrario. Otra alternativa consiste en elegir un número \(k\) de barras en función del tamaña muestral \(n\), como por ejemplo, el criterio de Sturges (\(k=1+\log_2(n)\)) o el criterio de Rule (\(k=2n^{1/3}\)). Abajo, un histograma con un número de barras que sigue este ultimo criterio:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{qplot}\NormalTok{(sleep_total,}\DataTypeTok{data=}\NormalTok{msleep,}\DataTypeTok{bins=}\DecValTok{8}\NormalTok{,}\DataTypeTok{color=}\KeywordTok{I}\NormalTok{(}\StringTok{"grey70"}\NormalTok{),}\DataTypeTok{fill=}\KeywordTok{I}\NormalTok{(}\StringTok{"lightblue"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-7-1.pdf}

\begin{nota}
El argumento \texttt{fill}controla el color de relleno de las barras y
el argumento \texttt{color} el color del borde. Para especificar un
color concreto se utiliza la función I(). Si el color varía con otra
variable \textbf{z}, se especifica esta dependencia escribiendo
fill=\textbf{z}.
\end{nota}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{qplot}\NormalTok{(sleep_total,}\DataTypeTok{data=}\NormalTok{msleep,}\DataTypeTok{bins=}\DecValTok{12}\NormalTok{,}\DataTypeTok{fill=}\NormalTok{vore) }\CommentTok{#distribución del tiempo de sueño según dieta del mamifero. Representación poco adecuada en general.}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-9-1.pdf}

\hypertarget{diagrama-de-caja-boxplot}{%
\subsubsection{Diagrama de caja (boxplot)}\label{diagrama-de-caja-boxplot}}

Otra representación similar es el diagrama de caja. Este diagrama describe la distribución de una variable numérica mediante una caja y unos segmentos que acotan las regiones donde la variable tiene el grueso de sus valores. Esta representación es menos fina que la del histograma pero es más robusta (menos sensible a valores extremos).

Esta representación es especialmente adecuada cuando se quiere describir como varía la distribución de una variable numérica en función de una variable categórica. Así, la distribución del tiempo de sueño según la dieta del mamífero se puede representar de la siguiente manera:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{qplot}\NormalTok{(vore,sleep_total,}\DataTypeTok{data=}\NormalTok{msleep,}\DataTypeTok{geom=}\StringTok{"boxplot"}\NormalTok{,}\DataTypeTok{xlab=}\StringTok{"Dieta"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-10-1.pdf}

\begin{ej}
Cargar la base de datos de la encuesta nacional americana \texttt{nhs} y
representar la distribución del índice de masa corporal (imc) según el
sexo o la raza.
\end{ej}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{load}\NormalTok{(}\StringTok{"data/nhs.RDA"}\NormalTok{)}
\CommentTok{#View(nhs)}
\end{Highlighting}
\end{Shaded}

\hypertarget{diagrama-de-barras}{%
\subsubsection{Diagrama de barras}\label{diagrama-de-barras}}

Los diagramas de barras permiten representar la distribución de una variable categórica. En esta representación, cada categoría viene representada por una barra cuya altura es proporcional a su frecuencia en la muestra.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{require}\NormalTok{(MASS)}
\KeywordTok{qplot}\NormalTok{(T.categ,}\DataTypeTok{data=}\NormalTok{Aids2,}\DataTypeTok{fill=}\KeywordTok{I}\NormalTok{(}\StringTok{"lightblue"}\NormalTok{)) }\CommentTok{#Distribución de las categorias de transmisión en unaa muestra de casos de SIDA (Australia, 1998)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-13-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{qplot}\NormalTok{(T.categ,}\DataTypeTok{data=}\NormalTok{Aids2,}\DataTypeTok{fill=}\NormalTok{status,}\DataTypeTok{color=}\KeywordTok{I}\NormalTok{(}\StringTok{"gray60"}\NormalTok{)) }\CommentTok{#Distribución del estado vital del caso según la categoria de transmisión del SIDA}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-13-2.pdf}

Utilizando el argumento \texttt{fill} se puede ver como varia esta distribución de acuerdo a otra variable (aquí la categoría de transmisión). El gráfico obtenido resulta poco claro y veremos más adelante como mejorarlo.

\begin{ej}
Representar la distribución de los hábitos con el tabaco según el sexo,
utilizando la muestra de la encuesta nacional americana.
\end{ej}

\hypertarget{relacion-entre-dos-variables}{%
\subsection{Relación entre dos variables}\label{relacion-entre-dos-variables}}

\hypertarget{diagrama-de-dispersion}{%
\subsubsection{Diagrama de dispersión}\label{diagrama-de-dispersion}}

Para describir la relación entre dos variables cuantitativas se suele utilizar gráficos de dispersión. Estos gráficos describen esta relación mediante una nube de puntos en un plano cartesiano. Cada punto de la nube corresponde a una fila de la base de datos y cada una de las variables corresponde a un eje.
En el gráfico siguiente se describe la relación entre las horas de sueño y el peso del animal:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{qplot}\NormalTok{(bodywt,sleep_total,}\DataTypeTok{data=}\NormalTok{msleep,}\DataTypeTok{xlab=}\StringTok{"peso (en kg, escala log)"}\NormalTok{,}\DataTypeTok{log=}\StringTok{"x"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-15-1.pdf}

Ajustando una curva suave (``smooth'') a la nube de puntos, se puede apreciar mejor la tendencia en esta relación:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{qplot}\NormalTok{(bodywt,sleep_total,}\DataTypeTok{data=}\NormalTok{msleep,}\DataTypeTok{log=}\StringTok{"x"}\NormalTok{,}\DataTypeTok{geom=}\StringTok{"smooth"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-16-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#qplot(bodywt,sleep_total,data=msleep,log="x",geom="smooth", method="lm") ## para ajutar una recta; "lm": linear model}
\end{Highlighting}
\end{Shaded}

Para evitar los problemas de solapamiento de puntos en la representación se puede poner algo de ruido en los datos ( \texttt{geom="jitter"} ), jugar con el tamaño de los puntos (\texttt{size}) o utilizar el parámetro de transparencia (\texttt{alpha}):

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{qplot}\NormalTok{(edad, imc,}\DataTypeTok{data=}\NormalTok{nhs,}\DataTypeTok{alpha=}\KeywordTok{I}\NormalTok{(.}\DecValTok{1}\NormalTok{),}\DataTypeTok{size=}\KeywordTok{I}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-17-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#qplot(edad, imc,data=nhs, alpha=I(.1),size=I(1), geom="jitter") #Mejor resultado añadiendo algo de ruido}
\end{Highlighting}
\end{Shaded}

\begin{ej}
Utilizando la encuesta nacional americana, describir la relación entre
la edad y el IMC. En un mismo gráfico, describir como esta relación
cambia con el sexo.
\end{ej}

\hypertarget{dotchart}{%
\subsubsection{Dotchart}\label{dotchart}}

Si una de las variables es categórica y tiene muchas categorías, el gráfico de dispersión puede ser también apropiado:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{qplot}\NormalTok{(sleep_total,order,}\DataTypeTok{data=}\NormalTok{msleep,}\DataTypeTok{col=}\NormalTok{vore) }
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-19-1.pdf}

Pero, es recomendable para mayor claridad ordenar la variable categórica de acuerdo a la otra variable:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{qplot}\NormalTok{(sleep_total,}\KeywordTok{reorder}\NormalTok{(order,sleep_total),}\DataTypeTok{data=}\NormalTok{msleep,}\DataTypeTok{col=}\NormalTok{vore,}\DataTypeTok{ylab=}\StringTok{"horas de sueño"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-20-1.pdf}

\begin{ej}
Describir con un gráfico similar al anterior, los datos de la base de
datos \texttt{islands} sobre superficies de islas. Puede ser oportuno
recurrir a una escala log.
\end{ej}

\hypertarget{relacion-con-una-variable-temporal}{%
\subsubsection{Relación con una variable temporal}\label{relacion-con-una-variable-temporal}}

Si una de las variables es el tiempo, a menudo es conveniente recurrir a lineas (\texttt{geom="line"}) en vez de puntos para representar la evolución de la otra variable.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{require}\NormalTok{(gapminder) }\CommentTok{#base de datos sobre esperanza de vida según caracteristicas socio-demograficas del pais}
\NormalTok{datos=}\KeywordTok{subset}\NormalTok{(gapminder,country }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Spain"}\NormalTok{,}\StringTok{"Greece"}\NormalTok{,}\StringTok{"Poland"}\NormalTok{)) }\CommentTok{#sólo se consideran España, Grecia y Polonia}
\KeywordTok{qplot}\NormalTok{(year,lifeExp,}\DataTypeTok{data=}\NormalTok{datos,}\DataTypeTok{geom=}\StringTok{"line"}\NormalTok{,}\DataTypeTok{color=}\NormalTok{country)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-22-1.pdf}

Sin embargo para representar la tendencia se utilizará la opción \texttt{geom="smooth"}:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{qplot}\NormalTok{(year,lifeExp,}\DataTypeTok{data=}\NormalTok{gapminder,}\DataTypeTok{geom=}\StringTok{"smooth"}\NormalTok{,}\DataTypeTok{color=}\NormalTok{continent,}\DataTypeTok{se=}\OtherTok{FALSE}\NormalTok{) }\CommentTok{#se=FALSE para quitar intervalos de confianza}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-23-1.pdf}

\begin{ej}
Describir con gráficos similares a los anteriores, los datos de la base
de datos \texttt{cancer} sobre la evolución de las tasas de mortalidad
por cáncer en España en el periodo 1975-2012. Empezar por ejemplo,
representando la evolución de la mortalidad por cáncer de pulmón según
el sexo.
\end{ej}

\hypertarget{graficos-avanzados}{%
\section{Gráficos avanzados}\label{graficos-avanzados}}

Esta sección es una introducción a las ideas del libro \emph{The Grammar of Graphics} de Leland Wilkinson (2005) tal y como vienen implementadas en el paquete \texttt{ggplot2} de Hadley Wickham (2009).

A continuación veremos los elementos principales de esta gramática y como nos permiten elaborar de manera sencilla representaciones visuales del comportamiento de una variable de interés a través de los distintos niveles de otras.

El gráfico siguiente muestra la evolución de la tasa de mortalidad por cáncer según la localización, en España durante el periodo 1975-2012.

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-25-1.pdf}

\hypertarget{elementos-de-un-grafico}{%
\subsection{Elementos de un gráfico}\label{elementos-de-un-grafico}}

El gráfico anterior, se obtuvo de la siguiente manera. En primer lugar, se carga los datos de mortalidad:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{require}\NormalTok{(data.table)}
\KeywordTok{load}\NormalTok{(}\StringTok{"data/cancer.RDA"}\NormalTok{) }\CommentTok{#carga los datos}
\NormalTok{cancer}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          sexo periodo             tumor       tasa
##    1: Hombres    1975 C.BUCAL Y FARINGE   5.541879
##    2: Hombres    1976 C.BUCAL Y FARINGE   5.512168
##    3: Hombres    1977 C.BUCAL Y FARINGE   5.827874
##    4: Hombres    1978 C.BUCAL Y FARINGE   5.323451
##    5: Hombres    1979 C.BUCAL Y FARINGE   5.461059
##   ---                                             
## 3188: Mujeres    2008 TODOS MUERTOS     385.294977
## 3189: Mujeres    2009 TODOS MUERTOS     373.009470
## 3190: Mujeres    2010 TODOS MUERTOS     359.444478
## 3191: Mujeres    2011 TODOS MUERTOS     357.461639
## 3192: Mujeres    2012 TODOS MUERTOS     359.691700
\end{verbatim}

La expresión de \texttt{ggplot2} para crear el gráfico fue:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(cancer) }\OperatorTok{+}
\StringTok{  }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ periodo, }\DataTypeTok{y =}\NormalTok{ tasa, }\DataTypeTok{col =}\NormalTok{ sexo) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\DataTypeTok{size=}\DecValTok{1}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{scale_y_log10}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{facet_wrap}\NormalTok{( }\OperatorTok{~}\StringTok{ }\NormalTok{tumor) }
\end{Highlighting}
\end{Shaded}

Esta expresión combina varios elementos que discutiremos con detalle más adelante:

\begin{itemize}
\tightlist
\item
  \textbf{Datos}: siempre un ``data.frame''
\item
  \textbf{Estéticas}: elementos representables gráficamente (la posición \texttt{x} e \texttt{y}, el color, la forma, \ldots) en columnas del data.frame.
\item
  \textbf{Geometrías} (o capas): puntos, rectas, histogramas, densidades, etc. También se llaman capas porque pueden superponerse.
\item
  \textbf{Facetas}: parten un gráfico en sublienzos preservando las escalas (pequeños múltiplos)
\end{itemize}

\hypertarget{datos}{%
\subsubsection{Datos}\label{datos}}

Uno de los elementos más importantes de un gráfico son los datos que se quieren representar. Una particularidad de \texttt{ggplot2} es que solo acepta un tipo de datos: \texttt{data.frames}.

Por otro lado, es preferible que los datos estén en un formato ``largo'' (long format), es decir, una columna para cada dimensión y una fila para cada observación.
Para ilustrar esta idea, se considera la base de datos \texttt{VADeaths} que proporciona tasas de mortalidad (por 1000 personas/año) en Virginia (1940) por grupos socio-demográficos y de edad.

\begin{tabular}{lrrrr}
\toprule
  & Rural Male & Rural Female & Urban Male & Urban Female\\
\midrule
50-54 & 11.7 & 8.7 & 15.4 & 8.4\\
55-59 & 18.1 & 11.7 & 24.3 & 13.6\\
60-64 & 26.9 & 20.3 & 37.0 & 19.3\\
65-69 & 41.0 & 30.9 & 54.6 & 35.1\\
70-74 & 66.0 & 54.3 & 71.1 & 50.0\\
\bottomrule
\end{tabular}

Antes de representar los datos, convertimos la base en un formato alargado.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{require}\NormalTok{(data.table)}
\NormalTok{mortalidad =}\StringTok{ }\KeywordTok{data.table}\NormalTok{(}\KeywordTok{melt}\NormalTok{(VADeaths))}
\KeywordTok{names}\NormalTok{(mortalidad) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"edad"}\NormalTok{,}\StringTok{"grupo"}\NormalTok{,}\StringTok{"tasa"}\NormalTok{)}
\NormalTok{mortalidad}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      edad        grupo tasa
##  1: 50-54   Rural Male 11.7
##  2: 55-59   Rural Male 18.1
##  3: 60-64   Rural Male 26.9
##  4: 65-69   Rural Male 41.0
##  5: 70-74   Rural Male 66.0
##  6: 50-54 Rural Female  8.7
##  7: 55-59 Rural Female 11.7
##  8: 60-64 Rural Female 20.3
##  9: 65-69 Rural Female 30.9
## 10: 70-74 Rural Female 54.3
## 11: 50-54   Urban Male 15.4
## 12: 55-59   Urban Male 24.3
## 13: 60-64   Urban Male 37.0
## 14: 65-69   Urban Male 54.6
## 15: 70-74   Urban Male 71.1
## 16: 50-54 Urban Female  8.4
## 17: 55-59 Urban Female 13.6
## 18: 60-64 Urban Female 19.3
## 19: 65-69 Urban Female 35.1
## 20: 70-74 Urban Female 50.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p <-}\StringTok{ }\KeywordTok{ggplot}\NormalTok{(mortalidad)}
\end{Highlighting}
\end{Shaded}

El código anterior crea un objeto, \texttt{p} que viene a ser un proto-gráfico: contiene los datos que vamos a utilizar, los del conjunto de datos \texttt{mortalidad}. Obviamente, el código anterior es insuficiente para crear un gráfico: aún no hemos indicado qué queremos hacer con \texttt{mortalidad}.

\hypertarget{esteticas-aes}{%
\subsubsection{\texorpdfstring{Estéticas (\texttt{aes})}{Estéticas (aes)}}\label{esteticas-aes}}

En un conjunto de datos hay columnas: edad, altura, ingresos, temperatura, etc. En un gráfico hay, en la terminología de \texttt{ggplot2}, \emph{aesthetic}. Estéticas son, por ejemplo, la distancia horizontal o vertical, el color, la forma (de un punto), el tamaño (de un punto o el grosor de una línea), etc.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p <-}\StringTok{ }\NormalTok{p }\OperatorTok{+}\StringTok{ }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ edad, }\DataTypeTok{y =}\NormalTok{ tasa, }\DataTypeTok{colour =}\NormalTok{ grupo)}
\end{Highlighting}
\end{Shaded}

se están añadiendo a \texttt{p} información sobre las estéticas que tiene que utilizar y qué variables de \texttt{mortalidad} tiene que utilizar:

\begin{itemize}
\tightlist
\item
  La abscisa \texttt{x}, vendrá dada por el grupo de edad.
\item
  La ordenada \texttt{y}, por la tasa de mortalidad.
\item
  El color, por el grupo socio-demográfico.
\end{itemize}

Al \emph{protográfico} se le han sumado las estéticas. En las secciones siguientes se le \emph{sumarán} otros elementos adicionales. Lo importante es recordar cómo la suma es el signo que combina los elementos que componen el lenguaje de los gráficos.

De todos modos, es habitual combinar ambos pasos en una única expresión

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p <-}\StringTok{ }\KeywordTok{ggplot}\NormalTok{(mortalidad, }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ edad, }\DataTypeTok{y =}\NormalTok{ tasa, }\DataTypeTok{colour =}\NormalTok{ grupo))}
\end{Highlighting}
\end{Shaded}

El objeto \texttt{p} resultante aún no es un gráfico ni se puede representar. Le faltan capas, que es el objeto de la siguiente sección. No obstante, se puede inspeccionar la relación (o \emph{mapeo}) entre estéticas y columnas de los datos:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p}\OperatorTok{$}\NormalTok{mapping}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Aesthetic mapping: 
## * `x`      -> `edad`
## * `y`      -> `tasa`
## * `colour` -> `grupo`
\end{verbatim}

¿Cuántas estéticas existen? Alrededor de una docena, aunque se utilizan, generalmente, menos:

\begin{itemize}
\tightlist
\item
  \texttt{x} e \texttt{y}, coordenadas horizontal y vertical.
\item
  \texttt{colour}, para el color.
\item
  \texttt{size}, para el tamaño.
\item
  \texttt{shape}, que indica la forma de los puntos (cuadrados, triángulos, etc.) de los puntos o del trazo (continuo, punteado) de las líneas.
\item
  \texttt{alpha} para la transparencia: los valores más altos tendrían formas opacas y los más bajos, casi transparentes. También muy útil para el solapamiento de puntos.
\item
  \texttt{fill}, para el color de relleno de las formas sólidas (barras, etc.).
\end{itemize}

\begin{nota}
Hay que advertir que no todas las \emph{estéticas} tienen la misma
potencia en un gráfico. El ojo humano percibe fácilmente longitudes
distintas. Pero tiene problemas para comparar áreas (que es lo que
regula la estética \texttt{size}) o intensidades de color. Se recomienda
usar las estéticas más potentes para representar las variables más
importantes.
\end{nota}

\hypertarget{capas-geoms}{%
\subsubsection{\texorpdfstring{Capas (\texttt{geoms})}{Capas (geoms)}}\label{capas-geoms}}

Las capas (o \texttt{geoms} para \texttt{ggplot2}) son los verbos del lenguaje de los gráficos. Indican qué hacer con los datos y las estéticas elegidas, cómo representarlos en un lienzo:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p <-}\StringTok{ }\NormalTok{p }\OperatorTok{+}\StringTok{ }\KeywordTok{geom_point}\NormalTok{()}
\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-35-1.pdf}

Una vez añadida una capa al gráfico, este puede pintarse (que es lo que ocurre al llamar a \texttt{p}). Se obtiene el mismo resultado haciendo, en una única línea,

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(mortalidad, }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ edad, }\DataTypeTok{y =}\NormalTok{ tasa, }\DataTypeTok{colour =}\NormalTok{ grupo)) }\OperatorTok{+}\StringTok{ }\KeywordTok{geom_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

Una característica de las capas, y de ahí su nombre, es que pueden superponerse. Por ejemplo,

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(mortalidad, }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ edad, }\DataTypeTok{y =}\NormalTok{ tasa, }\DataTypeTok{colour =}\NormalTok{ grupo, }\DataTypeTok{group=}\NormalTok{ grupo)) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{() }\OperatorTok{+}\StringTok{ }\KeywordTok{geom_line}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-37-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Se requiere la estética `group` para conectar los puntos de una linea cuando la variable en abscisa es un factor.}
\end{Highlighting}
\end{Shaded}

Existen muchos tipos de capas. Los más usuales son \texttt{geom\_point}, \texttt{geom\_line}, \texttt{geom\_histogram}, \texttt{geom\_bar} y \texttt{geom\_boxplot} (ver las página \texttt{http://docs.ggplot2.org/current/}) para una lista actualizada.

Abajo una representación mediante un diagrama de barra de los datos anteriores:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(mortalidad, }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ edad, }\DataTypeTok{y =}\NormalTok{ tasa, }\DataTypeTok{fill =}\NormalTok{ grupo)) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{(}\DataTypeTok{stat=}\StringTok{"identity"}\NormalTok{,}\DataTypeTok{position=}\StringTok{"dodge"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-38-1.pdf}

\begin{ej}
Elaborar el siguientes gráfico sobre la evolución del paro en España.
Utilizar la capa \texttt{geom\_smooth} para suavizar la tendencia y la
estética \texttt{linetype} para distintos tipos de curvas.
\end{ej}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-40-1.pdf}

\hypertarget{facetas}{%
\subsubsection{Facetas}\label{facetas}}

Las facetas permiten subdividir un gráfico y suele ser un recurso muy eficiente para describir el comportamiento de una variable en función de otra variable categórica. Así por ejemplo, con los datos de mortalidad,

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(mortalidad, }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ edad, }\DataTypeTok{y =}\NormalTok{ tasa)) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{(}\DataTypeTok{stat=}\StringTok{"identity"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(}\OperatorTok{~}\NormalTok{grupo)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-41-1.pdf}

crea tres gráficos dispuestos horizontalmente que comparan la relación entre la anchura y la longitud del pétalo de las tres especies de iris. Una característica de estos gráficos, que es crítica para poder hacer comparaciones adecuadas, es que comparten ejes.

Los gráficos podrían disponerse verticalmente reemplazando \texttt{facet\_grid(\textasciitilde{}grupo)} por \texttt{facet\_grid(grupo\textasciitilde{})} en el código anterior. Además, se puede subdividir el lienzo por dos (¡o más!) variables así:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mortalidad[,}\KeywordTok{c}\NormalTok{(}\StringTok{"zone"}\NormalTok{, }\StringTok{"sex"}\NormalTok{)}\OperatorTok{:}\ErrorTok{=}\StringTok{ }\KeywordTok{tstrsplit}\NormalTok{(grupo, }\StringTok{" "}\NormalTok{)]}
\KeywordTok{ggplot}\NormalTok{(mortalidad, }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ edad, }\DataTypeTok{y =}\NormalTok{ tasa)) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{(}\DataTypeTok{stat=}\StringTok{"identity"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(zone }\OperatorTok{~}\StringTok{ }\NormalTok{sex)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-42-1.pdf}

\begin{ej}
Elaborar los siguientes gráficos sobre la evolución del paro. Para el
segundo gráfico, se puede filtrar la base original con el comando:

paro.ZHT \textless- subset(paro,Provincia \%in\% c(``Zaragoza'',
``Huesca'', ``Teruel''))
\end{ej}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-44-1.pdf} \includegraphics{graficosConR_files/figure-latex/unnamed-chunk-44-2.pdf}

En caso de haber muchas categorías (p.e., todas las provincias), puede usarse la función \texttt{facet\_wrap} para distribuir las subgráficas en una cuadrícula (ver gráfico a principio de la sección).

\hypertarget{toque-final}{%
\subsubsection{Toque final}\label{toque-final}}

\hypertarget{etiquetas}{%
\paragraph{Etiquetas}\label{etiquetas}}

Las estéticas se pueden etiquetar con la función \texttt{labs}. Además, se le puede añadir un título al gráfico usando la función \texttt{ggtitle}. Por ejemplo, en el gráfico anterior se pueden re-etiquetar los ejes y la leyenda escribiendo

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obesidad<-}\KeywordTok{fread}\NormalTok{(}\StringTok{"data/obesidad.csv"}\NormalTok{)}
\NormalTok{p<-}\KeywordTok{ggplot}\NormalTok{(obesidad,}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x=}\NormalTok{renta,}\DataTypeTok{y=}\NormalTok{imc,}\DataTypeTok{color=}\NormalTok{region))}\OperatorTok{+}\KeywordTok{geom_smooth}\NormalTok{(}\DataTypeTok{method=}\StringTok{"lm"}\NormalTok{)}
\NormalTok{p }\OperatorTok{+}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"Relación entre Indice de Masa Corporal (IMC) y renta"}\NormalTok{) }\OperatorTok{+}\StringTok{ }
\StringTok{        }\KeywordTok{labs}\NormalTok{(}\DataTypeTok{x =} \StringTok{"Renta (en miles de $ por año)"}\NormalTok{, }\DataTypeTok{y =} \StringTok{"IMC (kg/m2)"}\NormalTok{, }\DataTypeTok{color =} \StringTok{"Continente"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-45-1.pdf}

\hypertarget{escalas}{%
\paragraph{Escalas}\label{escalas}}

Las escalas de las estéticas pueden ser modificadas para mejorar la claridad del gráfico.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p<-}\KeywordTok{ggplot}\NormalTok{(obesidad,}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x=}\NormalTok{renta,}\DataTypeTok{y=}\NormalTok{imc))}\OperatorTok{+}\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{size=}\NormalTok{.}\DecValTok{1}\NormalTok{)}\OperatorTok{+}\KeywordTok{geom_smooth}\NormalTok{(}\DataTypeTok{method=}\StringTok{"lm"}\NormalTok{)}
\NormalTok{p }
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-46-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p}\OperatorTok{+}\KeywordTok{scale_x_log10}\NormalTok{()}\OperatorTok{+}\KeywordTok{scale_y_continuous}\NormalTok{(}\DataTypeTok{breaks=}\KeywordTok{seq}\NormalTok{(}\DecValTok{10}\NormalTok{,}\DecValTok{50}\NormalTok{,}\DecValTok{10}\NormalTok{),}\DataTypeTok{trans=}\StringTok{"log"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-47-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(obesidad,}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x=}\NormalTok{renta,}\DataTypeTok{y=}\NormalTok{imc,}\DataTypeTok{color=}\NormalTok{region))}\OperatorTok{+}\KeywordTok{geom_smooth}\NormalTok{(}\DataTypeTok{method=}\StringTok{"lm"}\NormalTok{) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{size=}\NormalTok{.}\DecValTok{1}\NormalTok{,}\DataTypeTok{alpha=}\NormalTok{.}\DecValTok{1}\NormalTok{)}\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_x_log10}\NormalTok{()}\OperatorTok{+}\KeywordTok{scale_y_continuous}\NormalTok{(}\DataTypeTok{breaks=}\KeywordTok{seq}\NormalTok{(}\DecValTok{10}\NormalTok{,}\DecValTok{50}\NormalTok{,}\DecValTok{10}\NormalTok{),}\DataTypeTok{trans=}\StringTok{"log"}\NormalTok{)}\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_color_manual}\NormalTok{(}\StringTok{"Continente"}\NormalTok{,}\DataTypeTok{values=}\KeywordTok{c}\NormalTok{(}\StringTok{"green4"}\NormalTok{,}\StringTok{"red4"}\NormalTok{),}\DataTypeTok{limits=}\KeywordTok{c}\NormalTok{(}\StringTok{"Europa"}\NormalTok{,}\StringTok{"Asia"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-48-1.pdf}

\hypertarget{temas}{%
\paragraph{Temas}\label{temas}}

Los \emph{temas} de \texttt{ggplot2} permiten modificar aspectos estéticos del gráfico que no tienen que ver con los datos en sí. Eso incluye los ejes, etiquetas, colores de fondo, el tamaño de los márgenes, etc. Cambiar el tema por defecto, puede ser útil cuando los gráficos tienen que adecuarse a una imagen corporativa o atenerse a algún criterio de publicación.

El tema que usa \texttt{ggplot2} por defecto es \texttt{theme\_grey}. Al escribir \texttt{theme\_grey()} en la consola de R, se muestran alrededor de cuarenta elementos modificables y sus atributos tal y como los define dicho tema.

¿Qué se puede hacer con los temas? Una primera opción es elegir otro. Por ejemplo, se puede reemplazar el habitual por otros disponibles en el paquete como \texttt{theme\_bw} (o \texttt{theme\_classic}) haciendo

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}\StringTok{ }\KeywordTok{facet_grid}\NormalTok{(}\OperatorTok{~}\NormalTok{region) }\OperatorTok{+}\StringTok{ }\KeywordTok{theme_bw}\NormalTok{()}
\NormalTok{p }\OperatorTok{+}\StringTok{ }\KeywordTok{facet_grid}\NormalTok{(}\OperatorTok{~}\NormalTok{region) }\OperatorTok{+}\StringTok{ }\KeywordTok{theme_classic}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

Es posible usar tanto los temas que incluye \texttt{ggplot2} por defecto como otros creados por la comunidad. Algunos, por ejemplo, tratan de imitar el estilo de publicaciones reconocidas como The Economist o similares. Algunos están recogidos en paquetes como, por ejemplo, \texttt{ggthemes}.

\hypertarget{exportacion-de-los-graficos}{%
\paragraph{Exportación de los graficos}\label{exportacion-de-los-graficos}}

Una vez creado un gráfico, es posible exportarlo en diversos formatos:

\begin{itemize}
\tightlist
\item
  Imagen tipo bitmap (\texttt{jpeg},\texttt{png},\texttt{bmp},\texttt{tiff},\ldots)
\item
  Imagen vectorial (\texttt{pdf},\texttt{svg},\ldots)
\end{itemize}

La función \texttt{ggsave} guarda en un fichero el último gráfico generado con \texttt{ggplot2}. Lo hace, además, en el formato indicado en el nombre del fichero que se quiere generar. Así,

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggplot}\NormalTok{(obesidad,}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x=}\NormalTok{renta,}\DataTypeTok{y=}\NormalTok{imc,}\DataTypeTok{color=}\NormalTok{region))}\OperatorTok{+}\KeywordTok{geom_smooth}\NormalTok{(}\DataTypeTok{method=}\StringTok{"lm"}\NormalTok{)}
\KeywordTok{ggsave}\NormalTok{(}\StringTok{"obesidad.pdf"}\NormalTok{)}
\CommentTok{#ggsave("mortalidad.pdf", width = 20, height = 20, units = "cm")}
\KeywordTok{ggsave}\NormalTok{(}\StringTok{"obesidad.png"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Si no se especifica ruta, las imágenes serán guardadas en el directorio de trabajo.

\begin{nota}
Las imágenes vectoriales tienen una resolución ``infinita'' y suelen
ocupar poca memoria. Sin embargo, no todos los editores de texto admiten
este tipo de formato.
\end{nota}

\hypertarget{mapas}{%
\subsection{Mapas}\label{mapas}}

\begin{itemize}
\item
  Con \texttt{ggplot2} se puede también construir representaciones gráficas con información geográfica (puntos, segmentos, etc.): basta con que las estéticas \texttt{x} e \texttt{y} se correspondan con la longitud y la latitud de los datos.
\item
  Lo que permite hacer \texttt{ggmap} es, en esencia, añadir a los gráficos ya conocidos una capa cartográfica adicional. Para eso usa recursos disponibles en la \emph{web} a través de APIs (de Google y otros).
\end{itemize}

Un ejemplo sencillo ilustra los usos de \texttt{ggmap}. En primer lugar, se carga (si se ha instalado previamente) el paquete:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(ggmap)}
\end{Highlighting}
\end{Shaded}

Existen varios proveedores que proporcionan APIs de geolocalización. Uno de ellos es Google: dado el nombre más o menos normalizado de un lugar, la API de Google devuelve sus coordenadas. Este servicio tiene una versión gratuita que permite realizar un determinado número de consultas diarias (2500 actualmente); para usos más intensivos, es necesario adquirir una licencia.

La función \texttt{geocode} encapsula la consulta a dicha API y devuelve un objeto (un \texttt{data.frame}) que contiene las coordenadas del lugar de interés:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#ens <- geocode('Calle Monforte de Lemos 5, madrid') #ya no funciona!}
\NormalTok{ens<-}\KeywordTok{c}\NormalTok{(}\DataTypeTok{lat=} \FloatTok{40.47767}\NormalTok{,}\DataTypeTok{lon=}\OperatorTok{-}\FloatTok{3.691096}\NormalTok{)}
\CommentTok{### Una alternativa gratuita sin limites para direcciones en España }
\CommentTok{#require(caRtociudad)}
\CommentTok{#ens <- cartociudad_geocode('Calle Monforte de Lemos 5, madrid')}
\CommentTok{### Otra alternativa OSM}
\CommentTok{#require(tmaptools)}
\CommentTok{#ens=as.numeric(geocode_OSM('Monforte de Lemos 5, madrid')$coords)}
\end{Highlighting}
\end{Shaded}

La función \texttt{get\_map} consulta otro servicio de información cartográfica (GoogleMaps en el ejemplo siguiente) y descarga un mapa (que es, esencialmente, una imagen \emph{raster}).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{require}\NormalTok{(caRtociudad)}
\NormalTok{mapa=}\KeywordTok{get_cartociudad_map}\NormalTok{(ens,}\DataTypeTok{radius=}\DecValTok{2}\NormalTok{)}
\CommentTok{#ens<-c(left=-3.7,bottom=40.47,right=-3.68,top=40.485)}
\CommentTok{#mapa <- get_stamenmap(ens,zoom = 16,maptype="toner-lite")}
\end{Highlighting}
\end{Shaded}

Es obvio que para poder invocar las dos funciones anteriores hace falta una conexión a Internet. Sin embargo, el resto de las operaciones que se van a realizar se ejecutan localmente. Se puede, por ejemplo, representar el mapa directamente (con la función \texttt{ggmap}):

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggmap}\NormalTok{(mapa)}
\end{Highlighting}
\end{Shaded}

O bien se puede marcar sobre él puntos de interés:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{require}\NormalTok{(data.table)}
\CommentTok{# localización de los bares con terrazas de Madrid}
\CommentTok{# https://www.datanalytics.com/2017/03/02/todas-las-terrazas-de-madrid/}
\NormalTok{terrazas=}\KeywordTok{fread}\NormalTok{(}\StringTok{"data/terrazas.csv"}\NormalTok{) }

\KeywordTok{ggmap}\NormalTok{(mapa) }\OperatorTok{+}\StringTok{ }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ lon, }\DataTypeTok{y =}\NormalTok{ lat), }\DataTypeTok{data =}\NormalTok{ terrazas, }\DataTypeTok{colour =} \StringTok{'red3'}\NormalTok{,}\DataTypeTok{size =} \DecValTok{3}\NormalTok{,}\DataTypeTok{alpha=}\NormalTok{.}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-56-1} \end{center}

Como puede apreciarse, la sintaxis es similar a la de \texttt{ggplot2}. Una diferencia notables es que, ahora, los datos se pasan en la capa, es decir, en este caso, en la función \texttt{geom\_point}.

\hypertarget{mas-ejemplos-de-mapas-con-puntos}{%
\subsubsection{Más ejemplos de mapas con puntos}\label{mas-ejemplos-de-mapas-con-puntos}}

En los ejemplos que siguen se va a utilizar el conjunto de datos \texttt{crimes} que forma parte del paquete \texttt{ggmap} y que incluye información geolocalizada de crímenes cometidos en la ciudad de Houston. En realidad, solo consideraremos los crímenes \emph{serios}, es decir,

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{crimes.houston <-}\StringTok{ }\KeywordTok{subset}\NormalTok{(crime,}\OperatorTok{!}\NormalTok{crime}\OperatorTok{$}\NormalTok{offense }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"auto theft"}\NormalTok{, }\StringTok{"theft"}\NormalTok{, }\StringTok{"burglary"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

El tipo de mapas más simples son los que se limitan a representar puntos sobre una capa cartográfica.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#houston<-geocode('houston',source = "dsk")}
\NormalTok{houston=}\KeywordTok{c}\NormalTok{(}\DataTypeTok{left =} \FloatTok{-95.4}\NormalTok{, }\DataTypeTok{bottom =} \FloatTok{29.74}\NormalTok{, }\DataTypeTok{right =} \FloatTok{-95.35}\NormalTok{, }\DataTypeTok{top =} \FloatTok{29.78}\NormalTok{)}
\NormalTok{HoustonMap <-}\StringTok{ }\KeywordTok{ggmap}\NormalTok{(}\KeywordTok{get_stamenmap}\NormalTok{(houston,}\DataTypeTok{zoom=}\DecValTok{14}\NormalTok{,}\DataTypeTok{maptype=}\StringTok{"toner-lite"}\NormalTok{))}
\NormalTok{HoustonMap }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ lon, }\DataTypeTok{y =}\NormalTok{ lat, }\DataTypeTok{colour =}\NormalTok{ offense), }\DataTypeTok{data =}\NormalTok{ crimes.houston, }\DataTypeTok{size =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-57-1} \end{center}

\begin{ej}
Los mecanismos conocidos de \texttt{ggplot2}, como las facetas, están
disponibles en \texttt{ggmap}. Descomponer el anterior gráfico
utilizando \texttt{facet\_wrap} por tipo de crimen (ver gráfico
siguiente). Hacer lo mismo con el día de la semana.
\end{ej}

\begin{center}\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-59-1} \end{center}

\begin{ej}
Pintar las gasolineras en el mapa de España (o de una provincia o un
municipio) utilizando el fichero \texttt{data/carburantes.csv}.
Modificar el tamaño (o color) de los puntos en función de, por ejemplo,
el precio de los carburantes.
\end{ej}

\hypertarget{mas-alla-de-los-puntos-densidades-y-poligonos}{%
\subsubsection{Más allá de los puntos: densidades y poligonos}\label{mas-alla-de-los-puntos-densidades-y-poligonos}}

Además de \texttt{geom\_point}, también están disponibles otros tipos de capas de \texttt{ggplot2}, como \texttt{stat\_bin2d}, que cuenta el número de eventos (aquí atracos) que suceden en regiones cuadradas de un tamaño predefinido. Se puede también utilizar \texttt{stat\_density2d}, que representa densidades, para identificar las zonas de mayor criminalidad.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{HoustonMap }\OperatorTok{+}
\StringTok{  }\KeywordTok{stat_density2d}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ lon, }\DataTypeTok{y =}\NormalTok{ lat, }\DataTypeTok{alpha =}\NormalTok{ ..level..),}\DataTypeTok{fill=}\StringTok{"red4"}\NormalTok{,}
                 \DataTypeTok{size =} \DecValTok{2}\NormalTok{, }\DataTypeTok{data =} \KeywordTok{subset}\NormalTok{(crimes.houston,offense}\OperatorTok{==}\StringTok{"robbery"}\NormalTok{),}
                 \DataTypeTok{geom =} \StringTok{"polygon"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-62-1} \end{center}

Por otra parte, la información estadística puede ser proporcionada de manera agregada en unidades espaciales (a nivel provincial, municipal, \ldots), como para los datos del paro.

Lo primero que se necesita para representar estar datos, es el conjunto de polígonos (o ``shape'') que definen las secciones geográficas. Esta información se puede por ejemplo descargar desde el servidor \texttt{GADM}mediante el paquete \texttt{raster}:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{require}\NormalTok{(raster)  }
\NormalTok{shape <-}\StringTok{ }\KeywordTok{getData}\NormalTok{(}\StringTok{"GADM"}\NormalTok{, }\DataTypeTok{country=} \StringTok{"Spain"}\NormalTok{, }\DataTypeTok{level =} \DecValTok{2}\NormalTok{) }\CommentTok{#mapa administrativo a nivel provincial}
\NormalTok{peninsula <-}\StringTok{ }\KeywordTok{subset}\NormalTok{(shape,}\OperatorTok{!}\NormalTok{NAME_}\DecValTok{1}\OperatorTok{==}\StringTok{"Islas Canarias"}\NormalTok{) }\CommentTok{#mapa sin las islas canarias}
\NormalTok{peninsula }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## class       : SpatialPolygonsDataFrame 
## features    : 50 
## extent      : -9.301806, 4.328195, 35.17058, 43.79153  (xmin, xmax, ymin, ymax)
## crs         : +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 
## variables   : 13
## names       : GID_0, NAME_0,   GID_1,           NAME_1, NL_NAME_1,     GID_2,   NAME_2, VARNAME_2, NL_NAME_2,          TYPE_2,       ENGTYPE_2, CC_2,   HASC_2 
## min values  :   ESP,  Spain, ESP.1_1,        Andalucía,        NA, ESP.1.1_1, A Coruña,   Alacant,        NA, Ciudad Autónoma, Autonomous City,   01, ES.AN.AM 
## max values  :   ESP,  Spain, ESP.9_1, Región de Murcia,        NA, ESP.9.1_1, Zaragoza,  València,        NA,       Provincia,        Province,   52, ES.VC.VN
\end{verbatim}

Se puede representar este mapa mediante el comando \texttt{plot}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plot}\NormalTok{(peninsula,}\DataTypeTok{col=}\StringTok{"lightblue"}\NormalTok{)}
\KeywordTok{text}\NormalTok{(}\KeywordTok{coordinates}\NormalTok{(peninsula), }\DataTypeTok{labels=}\NormalTok{peninsula}\OperatorTok{$}\NormalTok{NAME_}\DecValTok{2}\NormalTok{,}\DataTypeTok{cex=}\NormalTok{.}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-64-1} \end{center}

o utilizando el paquete \texttt{ggplot2}:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#gpclibPermit()}
\NormalTok{peninsula.df=}\KeywordTok{fortify}\NormalTok{(peninsula,}\DataTypeTok{region=}\StringTok{"CC_2"}\NormalTok{) }\CommentTok{#convierte el shape en data.frames}
\KeywordTok{ggplot}\NormalTok{() }\OperatorTok{+}\StringTok{ }\KeywordTok{geom_polygon}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ peninsula.df, }\KeywordTok{aes}\NormalTok{(long, lat, }\DataTypeTok{group =}\NormalTok{ group), }
                        \DataTypeTok{fill=}\StringTok{"grey60"}\NormalTok{,}\DataTypeTok{colour =} \StringTok{"grey80"}\NormalTok{, }\DataTypeTok{size =} \FloatTok{.1}\NormalTok{)}\OperatorTok{+}\KeywordTok{coord_quickmap}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-65-1} \end{center}

Ahora pintamos en el mapa los datos del paro (Mujeres, 2011, primer trimestre):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{paro=}\KeywordTok{fread}\NormalTok{(}\StringTok{"data/paro.csv"}\NormalTok{,}\DataTypeTok{encoding=}\StringTok{"UTF-8"}\NormalTok{)}
\NormalTok{paro[,id}\OperatorTok{:}\ErrorTok{=}\KeywordTok{sub}\NormalTok{(}\StringTok{" "}\NormalTok{,}\StringTok{"0"}\NormalTok{,}\KeywordTok{format}\NormalTok{(Prov.id,}\DataTypeTok{width=}\DecValTok{2}\NormalTok{))]}
\NormalTok{Paro <-}\StringTok{ }\KeywordTok{subset}\NormalTok{(paro,Año}\OperatorTok{==}\DecValTok{2011} \OperatorTok{&}\StringTok{ }\NormalTok{Trimestre}\OperatorTok{==}\StringTok{"I"}\NormalTok{)}

\NormalTok{peninsula.paro=}\KeywordTok{merge}\NormalTok{(peninsula.df,Paro,}\DataTypeTok{by=}\StringTok{"id"}\NormalTok{) }\CommentTok{#juntamos las dos bases}

\KeywordTok{ggplot}\NormalTok{() }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_polygon}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ peninsula.paro, }\KeywordTok{aes}\NormalTok{(long, lat, }\DataTypeTok{group =}\NormalTok{ group,}\DataTypeTok{fill=}\NormalTok{Tasa.paro), }\DataTypeTok{colour =} \StringTok{"grey80"}\NormalTok{, }\DataTypeTok{size =} \FloatTok{.1}\NormalTok{) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(}\OperatorTok{~}\StringTok{ }\NormalTok{Sexo) }\OperatorTok{+}\StringTok{ }\KeywordTok{scale_fill_gradient}\NormalTok{(}\DataTypeTok{low=}\StringTok{"aliceblue"}\NormalTok{,}\DataTypeTok{high=}\StringTok{"steelblue4"}\NormalTok{)}\OperatorTok{+}\KeywordTok{coord_quickmap}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-66-1} \end{center}

Podemos incluso dibujar este mapa, sobre un lienzo obtenido mediante \texttt{get\_map}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bb=}\KeywordTok{bbox}\NormalTok{(peninsula)}
\NormalTok{españa <-}\StringTok{ }\KeywordTok{get_stamenmap}\NormalTok{(}\KeywordTok{c}\NormalTok{(bb),}\DataTypeTok{zoom=}\DecValTok{6}\NormalTok{,}\DataTypeTok{maptype=}\StringTok{"toner-lite"}\NormalTok{)}

\NormalTok{mujeres=}\KeywordTok{subset}\NormalTok{(peninsula.paro,Sexo}\OperatorTok{==}\StringTok{"Mujeres"}\NormalTok{)}

\KeywordTok{ggmap}\NormalTok{(españa) }\OperatorTok{+}\StringTok{ }\KeywordTok{geom_polygon}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ mujeres, }\KeywordTok{aes}\NormalTok{(long, lat, }\DataTypeTok{group =}\NormalTok{ group,}\DataTypeTok{fill=}\NormalTok{Tasa.paro),}\DataTypeTok{alpha=}\NormalTok{.}\DecValTok{5}\NormalTok{) }\OperatorTok{+}
\KeywordTok{scale_fill_gradient}\NormalTok{(}\DataTypeTok{low=}\StringTok{"aliceblue"}\NormalTok{,}\DataTypeTok{high=}\StringTok{"steelblue4"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-67-1} \end{center}

\hypertarget{arboles-filogeneticos}{%
\subsection{Árboles filogenéticos}\label{arboles-filogeneticos}}

\hypertarget{importacion-de-un-arbol}{%
\subsubsection{Importación de un árbol}\label{importacion-de-un-arbol}}

\begin{itemize}
\tightlist
\item
  Un árbol filogenético es un esquema arborescente que muestra las relaciones evolutivas entre varias especies u otras entidades que se cree que tienen una ascendencia común"" (Wikipedia).
\end{itemize}

\begin{figure}
\centering
\includegraphics{imagenes/Tree_of_life_int.svg.png}
\caption{El árbol de la vida}
\end{figure}

\begin{itemize}
\item
  El método de construcción de árboles filogenéticos consiste en analizar rasgos heredables (secuencias de ADN) o caracteres morfológicos con el fin de establecer relaciones de parentesco entre especies (o taxones). Casi todos los métodos filogenéticos comienzan con una matriz de distancia en la cual las diferencias entre taxones se estiman sumando discrepancias en nucleótidos o caracteres morfológicos cuantitativos. Cada nodo del árbol representa el ancestro común.
\item
  Sin embargo, aquí no entraremos en la construcción de los arboles, sino simplemente en su representación gráfica. Suponemos pues que ya disponemos de un árbol filogenético. El paquete \texttt{treeio} sirve como interfaz para importar varios arboles en varios formatos (Newick, Nexus, NHX, jplace, \ldots.).
\end{itemize}

EL siguiente comando permite instalar el paquete \texttt{ggtree}y sus dependencias (incluye el paquete \texttt{treeio}) desde el repositorio de \texttt{Bioconductor}.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\KeywordTok{requireNamespace}\NormalTok{(}\StringTok{"BiocManager"}\NormalTok{, }\DataTypeTok{quietly =} \OtherTok{TRUE}\NormalTok{))}
    \KeywordTok{install.packages}\NormalTok{(}\StringTok{"BiocManager"}\NormalTok{)}

\NormalTok{BiocManager}\OperatorTok{::}\KeywordTok{install}\NormalTok{(}\StringTok{"ggtree"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

A continuación importamos un árbol sobre filogenia de primates:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{require}\NormalTok{(gglot2)}
\KeywordTok{require}\NormalTok{(ggtree)}
\NormalTok{url=}\StringTok{"https://raw.githubusercontent.com/rgriff23/Dissertation/master/Chapter_2/data/tree.nex"}
\NormalTok{arbol <-}\StringTok{ }\KeywordTok{read.nexus}\NormalTok{(url)}
\KeywordTok{summary}\NormalTok{(arbol)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Phylogenetic tree: arbol 
## 
##   Number of tips: 65 
##   Number of nodes: 64 
##   Branch lengths:
##     mean: 10.01834 
##     variance: 67.22004 
##     distribution summary:
##      Min.   1st Qu.    Median   3rd Qu.      Max. 
##  0.401789  4.710731  8.266731 14.271122 51.124065 
##   No root edge.
##   First ten tip labels: Allenopithecus_nigroviridis 
##                         Cercopithecus_mitis
##                         Cercopithecus_petaurista
##                         Chlorocebus_sabaeus
##                         Erythrocebus_patas
##                         Miopithecus_ogouensis
##                         Avahi_laniger
##                         Cheirogaleus_major
##                         Daubentonia_madagascarensis
##                         Eulemur_fulvus
##   No node labels.
\end{verbatim}

\hypertarget{representacion-basica}{%
\subsubsection{Representación básica}\label{representacion-basica}}

Vamos ahora a Explorar la estructura del árbol mediante el comando \texttt{ggtree}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggtree}\NormalTok{(arbol)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-70-1.pdf}

Para poder añadir las etiquetas de los nodos finales utilizamos el comando \texttt{geom\_tiplab}:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggtree}\NormalTok{(arbol)}\OperatorTok{+}\KeywordTok{geom_tiplab}\NormalTok{(}\DataTypeTok{size=}\DecValTok{2}\NormalTok{,}\DataTypeTok{offset=}\NormalTok{.}\DecValTok{5}\NormalTok{)}\OperatorTok{+}\KeywordTok{xlim}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{100}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-71-1.pdf}

Además de la representación rectangular, otros sistemas de coordenadas (circular, radial, \ldots) son disponibles utilizando la opción \texttt{layout}:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{require}\NormalTok{(ggplot2)}
\NormalTok{pa <-}\KeywordTok{ggtree}\NormalTok{(arbol) }\OperatorTok{+}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"rectangular"}\NormalTok{)}
\NormalTok{pa.bis <-}\StringTok{ }\KeywordTok{ggtree}\NormalTok{(arbol) }\OperatorTok{+}\StringTok{ }\KeywordTok{coord_flip}\NormalTok{() }\OperatorTok{+}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"rectangular invertido"}\NormalTok{)}
\NormalTok{pb <-}\StringTok{ }\KeywordTok{ggtree}\NormalTok{(arbol, }\DataTypeTok{layout=}\StringTok{"slanted"}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"slanted"}\NormalTok{)}
\NormalTok{pc <-}\StringTok{ }\KeywordTok{ggtree}\NormalTok{(arbol, }\DataTypeTok{layout=}\StringTok{"circular"}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"circular"}\NormalTok{)}
\NormalTok{pd <-}\StringTok{ }\KeywordTok{ggtree}\NormalTok{(arbol, }\DataTypeTok{layout=}\StringTok{"radial"}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"radial"}\NormalTok{)}
\NormalTok{pe <-}\StringTok{ }\KeywordTok{ggtree}\NormalTok{(arbol, }\DataTypeTok{layout=}\StringTok{"unrooted"}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"unrooted"}\NormalTok{)}
\KeywordTok{multiplot}\NormalTok{(pa, pa.bis, pb, pc, pd, pe, }\DataTypeTok{ncol=}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-72-1.pdf}

\hypertarget{agrupacion-de-nodos}{%
\subsubsection{Agrupación de nodos}\label{agrupacion-de-nodos}}

La función \texttt{groupClade} permite agrupar nodos que comparten un mismo ancestro. A continuación agrupamos los nodos por familia de primates:
- Galagoidea (124)
- Lemuroidea (113)
- Tarsioidea (110)
- Ceboidea (96)
- Hominoidea (89)
- Cercopithecoidea (70)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nodos=}\KeywordTok{c}\NormalTok{(}\DecValTok{124}\NormalTok{, }\DecValTok{113}\NormalTok{, }\DecValTok{110}\NormalTok{, }\DecValTok{96}\NormalTok{, }\DecValTok{89}\NormalTok{, }\DecValTok{70}\NormalTok{)}
\NormalTok{arbol<-}\KeywordTok{groupClade}\NormalTok{(arbol,}\DataTypeTok{.node=}\NormalTok{nodos) }\CommentTok{#agrupación por especie}
\NormalTok{familias=}\KeywordTok{c}\NormalTok{(}\StringTok{"galagoids"}\NormalTok{,}\StringTok{"lemurs"}\NormalTok{,}\StringTok{"tarsiers"}\NormalTok{,}\StringTok{"cebids"}\NormalTok{,}\StringTok{"hominoids"}\NormalTok{,}\StringTok{"cercopithecoids"}\NormalTok{)}
\KeywordTok{ggtree}\NormalTok{(arbol, }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{color=}\NormalTok{group), }\DataTypeTok{layout=}\StringTok{'circular'}\NormalTok{) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_tiplab}\NormalTok{(}\DataTypeTok{size=}\DecValTok{2}\NormalTok{, }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{angle=}\NormalTok{angle))}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-73-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{code=}\StringTok{"ggtree(arbol, aes(color=group)) + geom_tiplab(size=2)"}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\DecValTok{6}\NormalTok{)\{}
\NormalTok{  mas=}\KeywordTok{paste0}\NormalTok{(}\StringTok{"geom_cladelabel("}\NormalTok{,nodos[i],}\StringTok{",'"}\NormalTok{,familias[i],}\StringTok{"',offset=25, barsize=2,offset.text=2.5, fontsize=2, hjust=.2)"}\NormalTok{)}
\NormalTok{  code=}\KeywordTok{paste}\NormalTok{(code,mas,}\DataTypeTok{sep=}\StringTok{"+"}\NormalTok{)}
\NormalTok{  \}}
\KeywordTok{eval}\NormalTok{(}\KeywordTok{parse}\NormalTok{(}\DataTypeTok{text=}\NormalTok{code))}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-74-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{##### Explorar la estructura de los siguientes arboles}
\NormalTok{arbol<-}\KeywordTok{read.tree}\NormalTok{(}\StringTok{"http://www.phytools.org/eqg2015/data/anole.tre"}\NormalTok{) }\CommentTok{#filogenia de lagartijas}
\NormalTok{arbol <-}\StringTok{ }\KeywordTok{read.nexus}\NormalTok{(}\StringTok{"https://raw.githubusercontent.com/rgriff23/Dissertation/master/Chapter_2/data/tree.nex"}\NormalTok{) }\CommentTok{#filogenia de primates}
\end{Highlighting}
\end{Shaded}

\hypertarget{anadir-heatmap}{%
\subsubsection{Añadir Heatmap}\label{anadir-heatmap}}

Simulamos cinco caracteres continuos (ejemplo: tamaño del cuerpo, \ldots) de acuerdo al árbol filogenia:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{require}\NormalTok{(phytools)}
\KeywordTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{) }\CommentTok{# simulacion reproducible}
\NormalTok{traits <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\KeywordTok{fastBM}\NormalTok{(arbol, }\DataTypeTok{nsim=}\DecValTok{5}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

utilizando las función \texttt{gheatmap} para adjuntar un \emph{heatmap} a la representación del árbol:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p <-}\StringTok{ }\KeywordTok{ggtree}\NormalTok{(arbol) }\OperatorTok{+}\StringTok{ }\KeywordTok{xlim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{geom_tiplab}\NormalTok{(}\DataTypeTok{size=}\DecValTok{2}\NormalTok{, }\DataTypeTok{offset=}\DecValTok{17}\NormalTok{) }

\CommentTok{# añade el heatmap}
\KeywordTok{gheatmap}\NormalTok{(p, traits, }\DataTypeTok{offset=}\FloatTok{0.2}\NormalTok{, }\DataTypeTok{width=}\FloatTok{0.2}\NormalTok{, }\DataTypeTok{low=}\StringTok{"darkgreen"}\NormalTok{, }\DataTypeTok{high=}\StringTok{"darkred"}\NormalTok{, }\DataTypeTok{colnames_position =} \StringTok{"top"}\NormalTok{, }\DataTypeTok{font.size=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-77-1.pdf}

\hypertarget{visualizacion-de-multiple-arboles}{%
\subsubsection{Visualización de multiple arboles}\label{visualizacion-de-multiple-arboles}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trees <-}\StringTok{ }\KeywordTok{lapply}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{40}\NormalTok{), rtree)}
\KeywordTok{class}\NormalTok{(trees) <-}\StringTok{ "multiPhylo"}
\KeywordTok{ggtree}\NormalTok{(trees) }\OperatorTok{+}\StringTok{ }\KeywordTok{facet_wrap}\NormalTok{(}\OperatorTok{~}\NormalTok{.id, }\DataTypeTok{scale=}\StringTok{"free"}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{geom_tiplab}\NormalTok{(}\DataTypeTok{size=}\DecValTok{2}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\includegraphics{graficosConR_files/figure-latex/unnamed-chunk-78-1.pdf}

\hypertarget{rmarkdown-y-shiny}{%
\section{Rmarkdown y shiny}\label{rmarkdown-y-shiny}}

Esta sección está dedicada a dos extensiones de R: \texttt{shiny} y \texttt{rmarkdown}. El primero de ellos permite crear cuadros de mando interactivos. El segundo, documentos automatizados que combinan texto con código, tablas y gráficos generados directamente por R.

Estos dos paquetes no son complejos sino, más bien, extensos y llenos de detalles. El objetivo de esta sesión es recorrer sus posibilidades.

\hypertarget{rmarkdown}{%
\subsection{Rmarkdown}\label{rmarkdown}}

Rmarkdown permite generar documentos dinámicos al mezclar texto formateado y resultados generados por R. Los documentos generados pueden estar en HTML, PDF, Word y muchos otros formatos.

Las ventajas de esta herramienta son numerosas:

\begin{itemize}
\tightlist
\item
  El código y sus resultados no están separados de los comentarios asociados a ellos
\item
  El documento final es reproducible
\item
  El documento se puede actualizar fácilmente, por ejemplo, si los datos de origen se han modificado.
\end{itemize}

Por lo tanto, es una herramienta muy práctica para exportar, comunicar y difundir resultados estadísticos.

Este documento se ha generado a partir de archivos R Markdown \^{} {[}Más precisamente gracias a la extensión \texttt{bookdown} que permite generar documentos de tipo libro{]}.

Aprender Rmarkdown implica aprender dos cosas distintas:

\begin{itemize}
\tightlist
\item
  Markdown, un \emph{formato} para escribir documentos simples en modo texto. Tiene la ventaja de ser fácilmente legible por humanos pero, a la vez, procesable programáticamente para volcarlos en otros formatos: pdf, html, \ldots{}
\item
  La integración entre R y markdown
\end{itemize}

Aquí, un documento de R Markdown básico:

\begin{verbatim}
---
title: "Ejemplo de R Markdown"
output: pdf_document
---

*R Markdown* permite mezclar :

- texto libre puesto en formato
- bloques de codigo de R

Los bloques de codigo se pueden ejecutar para incluir sus resultados en el documento,
así por ejemplo :

```{r}
mean(airquality$Ozone,na.rm=TRUE)
```

## Gráficos

Se puede también incluir __gráficos__ :

```{r}
plot(Ozone~Temp,data=airquality,bg="lightblue",pch=21)
```
\end{verbatim}

Al ``compilar'' el documento, el texto se formatea, los bloques de código se ejecutan, sus resultados se agregan al documento y todo se transforma en uno de los diferentes formatos posibles (html, pdf, word, \ldots).

Aquí, la representación del documento anterior en formato HTML

\includegraphics{resources/minimal.png}

\hypertarget{rmarkdown-en-15-mn}{%
\subsubsection{Rmarkdown en 15 mn}\label{rmarkdown-en-15-mn}}

Para aprender Markdown, se recomiendan los dos siguientes ejercicios :

\begin{ej}
Crear un fichero \texttt{.Rmd} usando
\texttt{File\ \textgreater{}\ New\ File\ \textgreater{}\ R\ Markdown}.
\end{ej}

Al crear un nuevo fichero de tipo \texttt{R\ Markdown}, RStudio proporciona, en lugar de uno vacío, una plantilla que muestra algunas de las opciones disponibles en este formato. Eso facilita el siguiente ejercicio:

\begin{ej}
Modificar el fichero de ejemplo creado en el ejercicio anterior
añadiéndole títulos de varios niveles, párrafos de texto, cursivas,
negritas, enlaces, listas (numeradas y sin numerar), etc. usando como
guía el
\href{https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf}{\texttt{Cheat\ Sheet}}
del paquete. \emph{Compilar} el documento (p.e., pulsando el botón con
la etiqueta \emph{Knit HTML} situado encima del panel de edición de
RStudio) para inspeccionar el resultado final.
\end{ej}

Se puede también generar documentos en formato Word y PDF. Para estos formato, es necesario tener instalados los programas : MS Word, LibreOffice o similar para el primero y LaTeX para el segundo.

El segundo de los componentes de Rmarkdown (y lo que lo diferencia de Markdown \emph{a secas}) es la posibilidad de incorporar bloques de código en el hilo del documento. Estos bloques de código se procesan durante la compilación del documento y los resultados que generan (tablas, gráficos, etc.) se integran en la salida. La plantilla de fichero Rmarkdown que genera RStudio incluye unos cuantos ejemplos de bloques de código.

\begin{ej}
Insertar sobre el documento (o sobre una nueva plantilla) bloques de
código de R que hagan alguna cosa. Los bloques de código incluyen
opciones en su encabezamiento (p.e., para que un bloque se ejecute o no;
para que el código se muestre o se oculte en el documento final, etc.).
Las opciones disponibles se pueden consultar en el
\href{https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf}{\texttt{Cheat\ Sheet}}
del paquete.
\end{ej}

\hypertarget{elementos-de-un-documento-rmarkdown}{%
\subsubsection{Elementos de un documento Rmarkdown}\label{elementos-de-un-documento-rmarkdown}}

\hypertarget{encabezado-preambulo}{%
\paragraph{Encabezado (préambulo)}\label{encabezado-preambulo}}

La primera parte del documento es su \emph{encabezado}. Se encuentra al principio del documento y está delimitado por tres guiones (\texttt{-\/-\/-}) antes y después:

\begin{verbatim}
---
title: "Titulo"
author: "Nombre Apellido"
date: "2 de mayo de 2018"
output: html_document
---
\end{verbatim}

Este encabezado contiene los metadatos del documento, como su título, autor, fecha, más una serie de opciones posibles que permiten configurar o personalizar todo el documento y su representación. Aquí, por ejemplo, la línea \texttt{output:\ html\_document} indica que el documento generado tendrá un formato HTML.

\hypertarget{texto-del-documento}{%
\paragraph{Texto del documento}\label{texto-del-documento}}

El cuerpo del documento consiste en texto con la sintaxis de Markdown: un marcado ligero que permite establecer niveles de títulos o formatear texto. Por ejemplo, el siguiente texto:

\begin{verbatim}
Este es un texto *en cursiva* y **en negrita**.

Se puede definir una lista así:

- primer elemento
- segundo elemento
\end{verbatim}

Que dará la siguiente salida

\begin{quote}
Este es un texto \emph{en cursiva} y \textbf{en negrita}.

Se puede definir una lista así:

\begin{itemize}
\tightlist
\item
  primer elemento
\item
  segundo elemento
\end{itemize}
\end{quote}

Los títulos de diferentes niveles se pueden definir comenzando una línea con uno o más caracteres \texttt{\#}:

\begin{verbatim}
# Titulo de nivel 1

## Titulo de nivel 2

### Titulo de nivel 3
\end{verbatim}

Cuando se han definido los títulos, al hacer clic en el icono \emph{Show document outline} en el extremo derecho de la barra de herramientas asociada al archivo, se muestra una tabla dinámica de contenidos generada automáticamente a partir de los títulos que permite navegar fácilmente en el documento.

La sintaxis de Markdown permite también insertar enlaces o imágenes. Por ejemplo, la siguiente sintaxis:

\begin{verbatim}
[ISCIII](http://www.isciii.es/)
\end{verbatim}

Dará el siguiente vinculo:

\begin{quote}
\href{http://www.isciii.es/}{ISCIII}
\end{quote}

En RStudio, el menú \emph{Help} y luego \emph{Markdown quick reference} proporciona una descripción más completa de la sintaxis.

\hypertarget{bloques-de-codigo}{%
\paragraph{Bloques de codigo}\label{bloques-de-codigo}}

Además del texto libre en formato Markdown, un documento R Markdown contiene, como su nombre indica, código R. Este código se incluye en fragmentos definidos por la siguiente sintaxis:

Como esta cadena de caracteres no es muy fácil de escribir, se puede usar \emph{R} en el menú Insertar de RStudio, o teclear el atajo \texttt{Ctrl+Alt+i}.

Se puede dar un nombre al bloque y se indica directamente después de \texttt{r}:

\texttt{\{r\ nombre\_del\_bloque\}}

No es obligatorio, pero puede ser útil en caso de error de compilación, para identificar el bloque que causó el problema. Atención, no podemos tener dos bloques con el mismo nombre.

Además de un nombre, se puede pasar a un bloque una serie de opciones para modificar su comportamiento.

\begin{verbatim}
```{r echo = FALSE, warning = FALSE}
x <- 1:5
```
\end{verbatim}

Una de las opciones más útiles es la opción \texttt{echo}. Por defecto \texttt{echo=TRUE}, y el bloque de código R se inserta en el documento generado:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x <-}\StringTok{ }\DecValTok{1}\OperatorTok{:}\DecValTok{5}
\KeywordTok{print}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 2 3 4 5
\end{verbatim}

Pero, si la opción \texttt{echo=FALSE}, entonces el código R ya no se inserta en el documento, y solo se el resultado será visible:

\begin{verbatim}
## [1] 1 2 3 4 5
\end{verbatim}

Aquí hay una lista de algunas de las opciones más comunes:

\begin{longtable}[]{@{}lll@{}}
\toprule
opción & valores & descripción\tabularnewline
\midrule
\endhead
echo & TRUE / FALSE & Mostrar o no el código R en el documento\tabularnewline
eval & TRUE / FALSE & Ejecutar o no el código R en tiempo de compilación\tabularnewline
warning & TRUE / FALSE & Mostrar o no las advertencias generadas por el bloque\tabularnewline
message & TRUE / FALSE & Mostrar o no los mensajes generados por el bloque\tabularnewline
\bottomrule
\end{longtable}

Hay muchas otras opciones descritas en la \href{https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf}{Guía de referencia de R Markdown}.

\hypertarget{tablas-con-rmarkdown}{%
\subsubsection{Tablas con Rmarkdown}\label{tablas-con-rmarkdown}}

\hypertarget{tablas-cruzadas}{%
\paragraph{Tablas cruzadas}\label{tablas-cruzadas}}

Por defecto, las tablas generadas por la función \texttt{table} se muestran tal y como aparecen en la consola de R, es decir, en texto sin formato:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# titanic<-ftable(Survived~Class,data=Titanic)}
\CommentTok{# Supervivencia al Titanic según clase}
\NormalTok{titanic<-}\KeywordTok{apply}\NormalTok{(Titanic,}\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{4}\NormalTok{),sum)}
\NormalTok{titanic}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       Survived
## Class   No Yes
##   1st  122 203
##   2nd  167 118
##   3rd  528 178
##   Crew 673 212
\end{verbatim}

Su presentación se puede mejorar utilizando la función \texttt{kable} de la extensión \texttt{knitr}:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(knitr)}
\KeywordTok{kable}\NormalTok{(titanic,}\DataTypeTok{caption=}\StringTok{"Supervivencia a la catastrofe del Titanic según la clase"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}[t]

\caption{\label{tab:unnamed-chunk-87}Supervivencia a la catastrofe del Titanic según la clase}
\centering
\begin{tabular}{l|r|r}
\hline
  & No & Yes\\
\hline
1st & 122 & 203\\
\hline
2nd & 167 & 118\\
\hline
3rd & 528 & 178\\
\hline
Crew & 673 & 212\\
\hline
\end{tabular}
\end{table}

\hypertarget{base-de-datos}{%
\paragraph{Base de datos}\label{base-de-datos}}

Respecto a las bases de datos (\texttt{tibble} o \texttt{data.frame}), la presentación HTML por defecto es el contenido que aparece en consola. Este formato puede ser poco adecuado si la tabla excede una cierta dimensión.

Una alternativa es usar la función \texttt{paged\_table}, que muestra una representación HTML paginada de la base:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{require}\NormalTok{(gapminder)}
\NormalTok{rmarkdown}\OperatorTok{::}\KeywordTok{paged_table}\NormalTok{(gapminder)}
\end{Highlighting}
\end{Shaded}

Otra alternativa es la función \texttt{datatable} de la extensión \texttt{DT}, que ofrece aún más interactividad:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(DT)}
\KeywordTok{datatable}\NormalTok{(gapminder)}
\end{Highlighting}
\end{Shaded}

En cualquier caso, no es recomendable mostrar una tabla de datos muy grandes de esta manera porque el archivo HTML resultante contendría todos los datos y, por lo tanto, sería muy grande.

\hypertarget{shiny}{%
\subsection{Shiny}\label{shiny}}

\texttt{shiny} es un paquete de R para la construcción de cuadros de mando \emph{web} interactivos. Permite, por ejemplo, crear interfaces para algoritmos o acceder y manipular tablas de datos a través de controles de HMTL: \emph{sliders}, botones, etc.

El paquete proporciona varias aplicaciones de ejemplo que usaremos para aprender los rudimentos de \texttt{shiny}. Por ejemplo, se puede hacer

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(shiny)}
\KeywordTok{runExample}\NormalTok{(}\DataTypeTok{example =} \StringTok{"01_hello"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

para desplegar la aplicación de ejemplo \texttt{01\_hello}. Esta aplicación pinta en el panel central un histograma y tiene en el lateral un \emph{slider} con el que modular su granularidad (técnicamente, para definir el número de pedazos, \emph{breaks}, en los que partir el rango de valores del vector subyacente).

Para detener la aplicación, en RStudio, presiona sobre el icono de la señal de \emph{stop} (en la parte superior de la ventana de la consola); en una terminal, usa Control-C para interrumpir la ejecución.

\begin{ej}
Ejecuta \texttt{runExample()} (sin argumento); el mensaje de error
indica qué otros ejemplos además de \texttt{01\_hello} están disponibles
por defecto. Échales un vistazo a algunos.
\end{ej}

\begin{ej}
Crea tu primera aplicación en \texttt{shiny}. Para ello, despliega
\texttt{01\_hello}. Luego, copia los ficheros \texttt{ui.r} y
\texttt{server.r} en un nuevo directorio vacío. Llámalo, por ejemplo,
\texttt{prueba00}. Luego ejecuta \texttt{runApp("prueba00")} para
desplegarla. (Nota: el argumento de \texttt{runApp} tiene que ser la
ruta, sea absoluta o relativa, del directorio en cuestión; recuerda que
una aplicación en \texttt{shiny} recibe el nombre del directorio que la
contiene).
\end{ej}

El ejercicio anterior muestra cómo construir aplicaciones en \texttt{shiny}. Una aplicación en \texttt{shiny} es un directorio que da nombre a la aplicación. Dentro de él tiene que haber, como mínimo, dos ficheros: \texttt{ui.r} y \texttt{server.r}. El primero define la interfaz de la aplicación. El segundo realiza los cálculos en segundo plano cada vez que el usuario manipula los controles de la interfaz.

Además de estos ficheros, en aplicaciones más complejas, puede haber otros organizados o no en subdirectorios: datos, otros ficheros auxiliares de código, logos, CSSs, imágenes estáticas, etc. Tendrás que leer la documentación de \texttt{shiny} para averiguar cómo y dónde colocar estos recursos adicionales.

\texttt{ui.r} y \texttt{server.r} se comunican entre sí: \texttt{ui.r} tiene que pasarle parámetros a \texttt{server.r} y este resultados a aquel. Esto se hace a través de variables y estructuras de datos con una forma muy particular. El siguiente ejercicio está pensado para que descubras el mecanismo de comunicación. Se te va a pedir que traduzcas el nombre de las variables y los parámetros al español. Obviamente, al traducir las variables en uno de los ficheros se romperá la aplicación. Realinear los nombres en el otro fichero te servirá para identificar los mecanismos de comunicación.

\begin{ej}
Crea \texttt{prueba01} como una copia de prueba00. Entonces, traduce al
español el nombre de todas las variables implicadas en la aplicación.
\end{ej}

El siguiente ejercicio te enseñará a modificar la interfaz de una aplicación en \texttt{shiny}, incorporar nuevos controles y añadir el código subyacente para que responda adecuadamente.

\begin{ej}
Añade a la aplicación \texttt{prueba01} otro \emph{slider} que mueva una
linea vertical roja que dibujes sobre el histograma. Es recomendable que
comiences, y en este orden, añadiendo una línea roja en algún punto (del
eje x) prefijado con la función \texttt{abline}, incorporando el
\emph{slider} y finalmente, vinculando el valor proporcionado por el
\emph{slider} al punto del eje x.

Nota: cuando modifiques \texttt{ui.r}, presta atención a la estructura
del programa y cómo se corresponde a la de la interfaz web: qué es lo
que va en la barra lateral, qué en el panel central, etc. Ten cuidado
además con los paréntesis: ¡hay muchos y es fácil desemparejarlos!
\end{ej}

\begin{ej}
Inspecciona el tutorial de \texttt{shiny}
(\href{http://shiny.rstudio.com/tutorial/}{\texttt{http://shiny.rstudio.com/tutorial/}})
para descubrir qué tipo \emph{widgets} (además de \emph{sliders})
existen, cómo se procesan esos \emph{inputs} en \texttt{server.r}, etc.
Recuerda que ese tutorial es la principal fuente de información sobre
todo lo relacionado con \texttt{shiny}.
\end{ej}

\begin{ej}
Visita la galería de aplicaciones de \texttt{shiny}
(\href{http://shiny.rstudio.com/gallery/}{\texttt{http://shiny.rstudio.com/gallery/}})
para investigar cómo implementar controles, qué tipos adicionales de
paneles existen, etc.
\end{ej}

Uno de los asuntos (avanzados) que se discuten en esas páginas es el de las reacciones: \texttt{shiny} está basado en un tipo de programación denominada \emph{reactiva}, que es la que permite que las funciones de \texttt{server.r} simulen estar escuchando (y \emph{reaccionen}) a los cambios que realiza el usuario en los controles de la aplicación. Puedes buscar en Internet más información sobre la \emph{programación reactiva} si te interesa el tema.

\hypertarget{referencias}{%
\section{Referencias}\label{referencias}}

Este curso está basado en las siguientes referencias:

\begin{itemize}
\item
  \emph{R para profesionales de los datos}, Carlos Bellosta, 2017,
  \href{https://datanalytics.com/libro_r}{\texttt{https://datanalytics.com/libro\_r}}
\item
  El libro \href{http://r4ds.had.co.nz/r-markdown.html}{R for data science} disponible en línea, que contiene un capítulo dedicado a R Markdown .
\end{itemize}

Y también muy inspirado de estos otros libros:

\begin{itemize}
\item
  \emph{Data Visualisation with R}, Thomas Rahlf, 2014, \href{http://www.datavisualisation-r.com/}{\texttt{http://www.datavisualisation-r.com/}}
\item
  \emph{R Graph Cookbook} , Hrishi Mittal, 2011
\end{itemize}


\end{document}
